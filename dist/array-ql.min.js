"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var r=[],i=!0,n=!1,a=void 0;try{for(var s,o=t[Symbol.iterator]();!(i=(s=o.next()).done)&&(r.push(s.value),!e||r.length!==e);i=!0);}catch(t){n=!0,a=t}finally{try{i||null==o.return||o.return()}finally{if(n)throw a}}return r}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}var ArrayQL=function(){function i(t,e){_classCallCheck(this,i);var r="string"==typeof t?require(t):t;if(!(r instanceof Array))throw new Error("List must be an array");this.trace=!1,this._srcArray=r,this.options=Object.assign({idName:"id",default:{},getters:{},trace:!1},e),this.trace=this.options.trace||!1,this._mapGetters(),this._mapDefaults(),this.idName=this.options.idName,this.resetResult(),this._nextId=this.maxId()+1}return _createClass(i,[{key:"resetResult",value:function(){return this._filtered=this._srcArray,this._unlimitedCount=this._filtered.length,this._keys=null,this._activeKey=null,this._selectedKyes=null,this._logic="and",this._limit=null,this._offset=null,this._trace("ArrayQL.select()",this._filtered.length),this}},{key:"_mapGetters",value:function(){var t=Object.keys(this.options.getters);t&&t.length&&this._srcArray.forEach(this._addGetters.bind(this))}},{key:"_addGetters",value:function(r){var i=this,t=Object.keys(this.options.getters);if(t&&t.length)return t.forEach(function(t){var e=i.options.getters[t];Object.defineProperty(r,t,{get:function(){return e.call(r,r)},enumerable:!0})}),r}},{key:"_mapDefaults",value:function(){var t=Object.keys(this.options.default);t&&t.length&&this._srcArray.forEach(this._addDefaults.bind(this))}},{key:"_addDefaults",value:function(e){var r=this,t=Object.keys(this.options.default);if(t&&t.length)return t.forEach(function(t){void 0===e[t]&&(e[t]=r.options.default[t])}),e}},{key:"maxId",value:function(){var e=this;return this._srcArray?this._srcArray.length?Math.max.apply(Math,_toConsumableArray(this._srcArray.map(function(t){return t[e.idName]}))):0:null}},{key:"select",value:function(t){if(this.resetResult(),!t)return this;if("string"!=typeof t&&!Array.isArray(t))throw new Error('"keys" must be an array of ids or comma separated string of ids, '.concat(_typeof(t)," given: ").concat(t));var e=Array.isArray(t)?t:t.split(/\s*,\s*/);return this._keys=e.map(function(t){var e=_slicedToArray(t.split(/\s+as\s+/).map(function(t){return t.trim()}),2),r=e[0],i=e[1];return{src:r,dest:i=i||r}}),this}},{key:"where",value:function(t){return this._activeKey=t,this}},{key:"and",value:function(t){return this._activeKey=t,this._logic="and",this}},{key:"or",value:function(t){return this._activeKey=t,this._logic="or",this}},{key:"concat",value:function(t){return this._activeKey=t,this._trace("ArrayQL.concat(".concat(t,")")),this}},{key:"isNull",value:function(){return this._filtrate(function(t){return null===t}),this._trace("ArrayQL.isNull(".concat(val,")"),this._filtered.length),this}},{key:"notNull",value:function(){return this._filtrate(function(t){return null!==t}),this._trace("ArrayQL.isNull(".concat(val,")"),this._filtered.length),this}},{key:"equalTo",value:function(e){return null==e||(this._filtrate(function(t){return t===e}),this._trace("ArrayQL.equalTo(".concat(e,")"),this._filtered.length)),this}},{key:"is",value:function(t){return this.equalTo(t)}},{key:"like",value:function(e){return null==e||(e=String(e).toLowerCase(),this._filtrate(function(t){return String(t).toLowerCase().includes(e)}),this._trace("ArrayQL.like(".concat(e,")"),this._filtered.length)),this}},{key:"lessThen",value:function(e){return null==e||this._filtrate(function(t){return Number(t)<e}),this}},{key:"lessThenOrEqual",value:function(e){return null==e||this._filtrate(function(t){return Number(t)<=e}),this}},{key:"greaterThen",value:function(e){return null==e||this._filtrate(function(t){return Number(t)>e}),this}},{key:"greaterThenOrEqual",value:function(e){return null==e||this._filtrate(function(t){return Number(t)>=e}),this}},{key:"gt",value:function(t){return this.greaterThen(t)}},{key:"lt",value:function(t){return this.lessThen(t)}},{key:"gte",value:function(t){return this.greaterThenOrEqual(t)}},{key:"lte",value:function(t){return this.lessThenOrEqual(t)}},{key:"between",value:function(e,r){return null==e&&(e=-1/0),null==r&&(r=1/0),this._filtrate(function(t){return Number(t)>=e&&Number(t)<=r}),this}},{key:"notBetween",value:function(e,r){if(null==e&&(e=-1/0),null==r&&(r=1/0),"number"!=typeof e)throw new Error('"notBetween" condition is only for numbers, '.concat(_typeof(e)," ").concat(e," given"));if("number"!=typeof r)throw new Error('"notBetween" condition is only for numbers, '.concat(_typeof(r)," ").concat(r," given"));return this._filtrate(function(t){return Number(t)<e||Number(t)>r}),this}},{key:"in",value:function(e){if(void 0!==e){if(!(e instanceof Array))throw new Error('"in" condition is only for arrays, '.concat(_typeof(e)," given"));return this._filtrate(function(t){return e.includes(t)}),this}}},{key:"notIn",value:function(e){if(void 0!==e){if(!(e instanceof Array))throw new Error('"notIn" condition is only for arrays, '.concat(_typeof(e)," given"));return this._filtrate(function(t){return!e.includes(t)}),this}}},{key:"_filtrate",value:function(r){var i=this;if("or"===this._logic)for(var t=0;t<this._srcArray.length;t++){var e=this._srcArray[t],n=this._extractValue(e);r.call(null,n)&&(this._filtered.includes(e)||this._filtered.push(e))}else this._filtered=this._filtered.filter(function(t){var e=i._extractValue(t);return r.call(null,e)});return this._unlimitedCount=this._filtered.length,this}},{key:"_trace",value:function(){if(this.trace){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];console.log.apply(null,e)}}},{key:"map",value:function(t){return this._filtered=this._filtered.map(t),this}},{key:"filter",value:function(t){return this._filtered=this._filtered.filter(t),this}},{key:"_extractDotted",value:function(t,e){if(!t)return t;if(!e.includes("."))return t[e];for(var r=e.split("."),i=t,n=0;n<r.length;n++){if(void 0===i)return;i=i[r[n]]}return i}},{key:"_extractValue",value:function(t,e){return void 0===e&&(e=this._activeKey),this._extractDotted(t,e)}},{key:"_clone",value:function(t){return JSON.parse(JSON.stringify(t))}},{key:"sort",value:function(i,t){var n=1<arguments.length&&void 0!==t?t:"desc";if(null==i)return this;return this._filtered.sort(function(t,e){var r=t[i]>e[i]?1:-1;return"asc"===n?r:-1*r}),this}},{key:"orderBy",value:function(t,e){return this.sort(t,e)}},{key:"limit",value:function(t,e){var r=0<arguments.length&&void 0!==t?t:0,i=1<arguments.length&&void 0!==e?e:15;if(i=Number(i),r=Number(r),this._offset=r,this._limit=i,0===this.limit)throw new Error("Unreasonable value of Limit=0");var n=i*r,a=n+i;return this._filtered=this._filtered.slice(n,a),this._trace("ArrayQL.limit(".concat(i,", ").concat(r,")"),this._filtered.length),this}},{key:"insert",value:function(e){var r=this;if(void 0!==(e=Object.assign({},this.options.default,e))[this.idName]&&null!==e[this.idName]){if(this._srcArray.find(function(t){return t[r.idName]===e[r.idName]}))throw new Error('Item with id "'.concat(e[this.idName],'" already exist'))}else e[this.idName]=this._nextId++;return this._addGetters(e),this._srcArray.push(e),this._trace("ArrayQL.insert()",this._filtered.length),e}},{key:"update",value:function(e){var r=this;if(null===e[this.idName]||void 0===e[this.idName])throw new Error("No id specified for update");var t=this._srcArray.find(function(t){return t[r.idName]===e[r.idName]});if(!t)throw new Error('No element with id "'.concat(e[this.idName],'" found for update'));return this.trace&&console.log("ArrayQL.update()",this._filtered.length),Object.assign(t,e),t}},{key:"delete",value:function(e){var r=this;if(null==e)throw new Error("No ids specified to delete");e instanceof Array||(e=[e]);var i=[];return this._srcArray=this._srcArray.filter(function(t){return!e.includes(t[r.idName])||(i.push(t),!1)}),this._trace("ArrayQL.delete()",this._filtered.length),i}},{key:"getById",value:function(e){var r=this,t=this._srcArray.find(function(t){return t[r.idName]===e});if(!t)throw new Error('No record with id "'.concat(e,'" found'));return t}},{key:"get",value:function(){return this.getById()}},{key:"count",value:function(){return this._filtered.length}},{key:"unlimitedCount",value:function(){return this._unlimitedCount}},{key:"getList",value:function(){var i=this;return this._keys?this._filtered.map(function(e){var r={};return i._keys.forEach(function(t){r[t.dest]=i._extractValue(e,t.src)}),r}):this._filtered}},{key:"getResult",value:function(){var t=this.getList(),e=this._limit?Math.ceil(this._unlimitedCount/this._limit):null;return{content:t,totalElements:this._unlimitedCount,totalPages:e,last:this._limit?this._limit*this._offset>=e:null,first:this._limit?0===this._offset:null}}}]),i}();"undefined"!=typeof module&&module.exports&&(module.exports=ArrayQL);